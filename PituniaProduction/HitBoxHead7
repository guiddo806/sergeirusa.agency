if (not _G.Flags) then
	_G.Flags = {
		ESP = {
			NotVisibleColor = Color3.fromRGB(255,0,0);
			VisibleColor = Color3.fromRGB(0,255,0);	
			DistanceLimit = 0;
			Box = false;
			Name = false;
			Weapon = false;
			Distance = false;
			VisibleCheck = false;
			Sleepers = false;
		};
		HitboxExpander = {
			Size = 7;
			Enabled = true;
			Transparency = .7; -- 1 = invisible, 0 = fully visible (0 not recommended)
			Part = "Head"; -- {"Torso","Head","rest of the body parts"}
		};
	};
end
if (not _G.Loaded) then
	_G.Loaded = true;
	local ReplicatedStorage = game:GetService("ReplicatedStorage");
	local RunService = game:GetService("RunService");
	local Items = ReplicatedStorage:WaitForChild("HandModels");
	local CoreGui = game:GetService("CoreGui");
	local CurrentCamera = workspace.CurrentCamera;
	local IgnoreFolder = workspace:WaitForChild("Ignore");
	local OriginalSizes = {};
	local WeaponInfo = {};

	local SleepAnimationId = "rbxassetid://13280887764"
	
for i,v in pairs(ReplicatedStorage.Shared.entities.Player.Model:GetChildren()) do
		if v:IsA("BasePart") then
			OriginalSizes[v.Name] = v.Size;
		end
	end


	for i,v in pairs(Items:GetChildren()) do
		v:SetAttribute("RealName",v.Name);--[v.DataCost] = v.Name;
	end

	function IsSleeping(Player)
		local Animations = Player.AnimationController:GetPlayingAnimationTracks();
		for i,v in pairs(Animations) do
			if (v.IsPlaying and v.Animation.AnimationId == SleepAnimationId) then
				return true;
			end
		end
		return false;
	end


	function PlayerWeapon(Player)
		local Model = Player:FindFirstChildOfClass("Model");
		return Model and Model:GetAttribute("RealName") or "None";
	end

	function IsPlayer(Model)
		return Model.ClassName == "Model" and Model:FindFirstChild("Head") and Model.PrimaryPart~=nil;
	end

	function SetColor(Billboard,Color) 
		Billboard.PlayerName.TextColor3 = Color;
		Billboard.PlayerDistance.TextColor3 = Color;
		Billboard.PlayerWeapon.TextColor3 = Color;
		Billboard.Box.UIStroke.Color = Color;
	end

	function HitboxExpander(Model,Size,Hitbox)
		if (Hitbox.Enabled) then
			local Part = Model[Hitbox.Part];
			Part.Size = Vector3.new(Size,Size,Size);
			Part.Transparency = Hitbox.Transparency;
			Part.CanCollide = false;
		else
			local Part = Model[Hitbox.Part];
			Part.Size = OriginalSizes[Hitbox.Part];
			Part.Transparency = 0;
			Part.CanCollide = true;
		end
	end

	local HasESP = {};
	RunService.Heartbeat:Connect(function()
		local ESP =  _G.Flags.ESP;
		local Hitbox = _G.Flags.HitboxExpander;
		for i,v in pairs(workspace:GetChildren()) do
			if (HasESP[v] or IsPlayer(v)) then
				if (HasESP[v] == nil) then
					local Billboard = CreateESP();
					HasESP[v] = Billboard;
					Billboard.Adornee = v.PrimaryPart;
				elseif (HasESP[v] ~= nil) then
					local Billboard = HasESP[v];
					local PrimaryPosition = v.PrimaryPart.Position;
					local Origin = CurrentCamera.CFrame.Position;
					local Distance = (Origin-PrimaryPosition).Magnitude;
					HitboxExpander(v,Hitbox.Size,Hitbox);
					local Sleeping = IsSleeping(v);
					if ((Distance > ESP.DistanceLimit) or (not ESP.Sleepers and Sleeping)) then
						Billboard.Enabled = false;
						continue;
					end

					Billboard.Enabled = false;
					Billboard.Adornee = v.PrimaryPart;

					Billboard.Box.Visible = ESP.Box;
					Billboard.PlayerDistance.Visible = ESP.Distance;
					Billboard.PlayerName.Visible = ESP.Name;
					Billboard.PlayerWeapon.Visible = ESP.Weapon;

					Billboard.PlayerDistance.Text = math.round(Distance) .. "s";
					Billboard.PlayerWeapon.Text = PlayerWeapon(v);
					
if (v.Head.Nametag.tag.Text ~= "") then
     Billboard.PlayerName.Text = v.Head.Nametag.tag.Text;
end 
			local Params = RaycastParams.new();
					Params.FilterDescendantsInstances = {IgnoreFolder,v};
					local Direction = PrimaryPosition - Origin;
					local Raycast = workspace:Raycast(Origin,Direction,Params);
					SetColor(Billboard, if (not Raycast or not ESP.VisibleCheck) then ESP.VisibleColor else ESP.NotVisibleColor);
				end	
			end
		end
	end)
end
